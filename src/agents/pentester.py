from crewai import Agent
# ğŸ”¥ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: CodeReaderTool Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† FileReadTool
from src.tools.file_tools import CodeReaderTool, SASTTool
from src.brain import get_llm
from src.tools.scanner_tools import (
    ShodanTool, 
    NiktoTool, 
    CVESearchTool,
    DirectorySearchTool,
    SubdomainTool,    # ğŸ†•
    JSSensitiveTool   # ğŸ†•
)
import yaml
import os

os.environ["OPENAI_API_KEY"] = "sk-no-openai"
os.environ["OPENAI_BASE_URL"] = "http://127.0.0.1:9999"

class PentestAgents:
    def __init__(self, llm):
        self.llm = llm
        
        base_path = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
        config_path = os.path.join(base_path, 'config', 'agents.yaml')
        
        with open(config_path, 'r', encoding='utf-8') as file:
            self.config = yaml.safe_load(file)

    def scanner_agent(self):
        # 1. Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ­Øµ (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        tools = [
            ShodanTool(),
            NiktoTool(),
            CVESearchTool(),
            DirectorySearchTool(),
            SubdomainTool(),   # ğŸ”¥
            JSSensitiveTool()  # ğŸ”¥
        ]
        
        return Agent(
            role=self.config['pentester']['role'],
            goal="Perform deep reconnaissance including subdomains, open ports, and JS secrets.",
            backstory=self.config['pentester']['backstory'],
            verbose=True,
            memory=False,
            # ğŸ”¥ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙÙˆÙŠØ¶ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
            allow_delegation=False,
            tools=tools,
            llm=self.llm,
            max_iter=15
        )

    def report_writer_agent(self):
        # ÙƒØ§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø¨Ø¯ÙˆÙ† Ø£Ø¯ÙˆØ§Øª)
        return Agent(
            role="Senior Security Reporter",
            goal="Write comprehensive penetration testing reports based ONLY on provided context.",
            backstory="You are a technical writer. You do NOT use tools. You do NOT talk to others. You ONLY write reports based on the data given to you.",
            verbose=True,
            memory=False,
            # ğŸ”¥ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙÙˆÙŠØ¶ ØªÙ…Ø§Ù…Ø§Ù‹
            allow_delegation=False,
            tools=[],
            llm=self.llm
        )

    def coder_agent(self):
        # Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆØ¯ (ØªÙ… Ø¥Ø¶Ø§ÙØ© SAST ÙˆØªØµØ­ÙŠØ­ Ù‚Ø§Ø±Ø¦ Ø§Ù„Ù…Ù„ÙØ§Øª)
        return Agent(
            role=self.config['code_auditor']['role'],
            goal=self.config['code_auditor']['goal'],
            backstory=self.config['code_auditor']['backstory'],
            verbose=True,
            memory=False,
            allow_delegation=False,
            tools=[
                CodeReaderTool(), # âœ… Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­
                SASTTool()        # ğŸ”¥ Bandit Scanner
            ],
            llm=self.llm
        )